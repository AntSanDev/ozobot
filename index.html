<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>FlashForth for Ozobot</title>
        <style>
            html { height: 100% }
            body { height: 100%; background: black; color: white; margin: 0; padding: 1em; text-align: center; font-family: sans-serif; margin: 0; padding: 0; }
            a { color: white; }
            table { width: 100%; height: 100%; padding: 0.5em; }
            tr#panelrow { height: 100%; vertical-align: top; }
            td.spacer { border-bottom: 1px solid white; }
            td.tab { border: 1px solid gray; border-bottom: 1px solid white; color: gray; padding: 0.5em 1em 0.5em 1em; cursor: pointer; }
            td.selected { border: 1px solid white; border-bottom: none; background: #222; color: white; cursor: auto; }
            #panels { border-left: 1px solid white; border-right: 1px solid white; border-bottom: 1px solid white; background: #222; padding: 1em; }
            div#source { text-align: left; font-family: monospace; height: 100%; border: 1px solid gray; background: black; padding: 0.5em; }
            button { border: 1px solid white; background: black; color: white; padding: 0.5em; margin-bottom: 1em; }
            #pad { margin: 0 auto; width: 20em; height: 20em; -webkit-border-radius: 10em; -moz-border-radius: 10em; border-radius: 10em; }
            #flash span { -webkit-border-radius: 10px; -moz-border-radius: 10px; border-radius: 10px; font-size: 10px; }
            #help td { border: 1px solid gray; padding: 0.1em; padding-left: 0.5em; padding-right: 0.5em; margin: 0; text-align: left; }
            .W { background: #fff; border: 1px solid #000; }
            .R { background: #f00; border: 1px solid #000; }
            .G { background: #0f0; border: 1px solid #000; }
            .B { background: #00f; border: 1px solid #000; }
            .C { background: #0ff; border: 1px solid #000; }
            .M { background: #f0f; border: 1px solid #000; }
            .Y { background: #ff0; border: 1px solid #000; }
            .K { background: #000; border: 1px solid #555; }
            .comment { color: white; }
            .word { color: #0f0; }
            .literal { color: yellow; }
            .error { color: red; }
            #panel_samples { text-align: left; }
            #panel_samples a { font-weight: bold; }
        </style>
        <script>
            var compilerStack = [];

            function mwhile(asm) {
                compilerStack.push(asm.length); // mark beginning of predicate
            }

            function mdo(asm) {
                asm.push(0x80); // if
                compilerStack.push(asm.length); // mark position of `if` address
                asm.push(0x0); // placeholder
                asm.push(0x97); // unknown purpose
            }

            function mloop(asm) {
                var ifaddr = compilerStack.pop();
                var whileaddr = compilerStack.pop();
                // ba f0 97 - `loop` form (jump -16 ??)
                asm.push(0xba); // jump
                var back = asm.length - whileaddr - 1;
                asm.push((~back + 1) & 0xff); // relative back
                asm.push(0x97); // unknown purpose
                asm[ifaddr] = asm.length - ifaddr + 1; // patch `if` address
            }

            var dictionary  = {
            'TRUE'  : { op: 1   , sig: '-1'   , help: 'True constant' },
            'FALSE' : { op: 0   , sig: '-0'   , help: 'False constant' },
            'OFF'   : { op: 0   , sig: '-0'   , help: 'Switch robot off. Argument to `end`' },
            'LINE'  : { op: 1   , sig: '-1'   , help: 'Switch to line following. Argument to `end`' },
            'IDLE'  : { op: 2   , sig: '-2'   , help: 'Switch to idle. Argument to `end`' },
            'COLOR' : { op: 0x0e, sig: '-14'  , help: 'Color sensor constant (14). Used with `sensor` word)' },
            '~'     : { op: 0x83, sig: 'x-x'  , help: 'Bitwise not value' },
            '+'     : { op: 0x85, sig: 'yx-z' , help: 'Addition (x + y)' },
            '-'     : { op: 0x86, sig: 'yx-z' , help: 'Subtraction (x - y)' },
            '*'     : { op: 0x87, sig: 'yx-z' , help: 'Multiplication (x * y)' },
            '/'     : { op: 0x88, sig: 'yx-z' , help: 'Division (x / y)' },
            'mod'   : { op: 0x89, sig: 'yx-z' , help: 'Modulus (x mod y)' },
            'not'   : { op: 0x8a, sig: 'x-x'  , help: 'Boolean not value' },
            'neg'   : { op: 0x8b, sig: 'x-x'  , help: 'Negated values value (e.g. used to generate negative literals)' },
            'rand'  : { op: 0x8c, sig: 'mn-r' , help: 'Random number from n to m' },
            'call'  : { op: 0x90, sig: ':addr', help: 'Call address (used by compiler)', internal: true },
            ';'     : { op: 0x91, sig: '-'    , help: 'Return from call (used by compiler)', internal: true },
            'turn'  : { op: 0x98, sig: 'as-'  , help: 'Turn angle (deg)/speed (mm/s)' },
            'wait'  : { op: 0x9b, sig: 'x'    , help: 'Wait x centiseconds (x * 10ms)' },
            '>='    : { op: 0x9c, sig: 'x-x'  , help: 'Greater than or equal. (< is `>= not`)' },
            '>'     : { op: 0x9d, sig: 'x'    , help: 'Greater than. (<= is `> not`)' },
            'move'  : { op: 0x9e, sig: 'ds-'  , help: 'Move distance (mm, negative for reverse)/speed (mm/s)' },
            'wheels': { op: 0x9f, sig: 'lr-'  , help: 'Set left/right wheel speeds (mm/s, negative for reverse)' },
            '='     : { op: 0xa4, sig: 'yx-'  , help: 'Equality (x = y)' },
            'poke'  : { op: 0xa6, sig: 'xn-'  , help: 'Poke value (x) to caller\' nth stack item (used by compiler)', internal: true },
            'peek'  : { op: 0xa7, sig: 'n-x'  , help: 'Peek value from caller\' nth stack item (used by compiler)', internal: true },
            'abs'   : { op: 0xa8, sig: 'x-x'  , help: 'Absolute value.' },
            'end'   : { op: 0xae, sig: 'm-'   , help: 'End program and switch to mode `m` (see `OFF`, `LINE`, `IDLE`)' },
            'led'   : { op: 0xb8, sig: 'rgb'  , help: 'Set R, G, B values (0-127)' },
            'sensor': { op: 0x92, sig: 's-v'  , help: 'Get sensor value' },
            'while': { macro: mwhile, sig: 'b-', help: 'Begin conditional loop predicate. `while` <predicate> `do` ... `loop`' },
            'do': { macro: mdo, sig: '-', help: 'Begin conditional loop body. <predicate> `while` <predicate> `do` ... `loop`' },
            'loop'  : { macro: mloop,  sig: '-' , help: 'End conditional loop. <predicate> `while` <predicate> `do` ... `loop`' },
        };

        function updateCodeHtml(html) {
            // TODO: update in place (but this breaks cursor movement)
            // var sel = window.getSelection();
            // var parid = sel.anchorNode ? sel.anchorNode.parentElement.id : null;
            document.getElementById('syntax').innerHTML = html;
            // if (sel.anchorNode) {
            //     var range = document.createRange();
            //     var el = document.getElementById(parid);
            //     var txt = el.textContent;
            //     range.selectNodeContents(el);
            //     range.collapse(true);
            //     range.setStart(el, 1);
            //     var sel2 = window.getSelection();
            //     sel2.removeAllRanges();
            //     sel2.addRange(range);
            // }
        }

        function assemble(source) {
            var h = '';
            var id = 0;
            function addWord(word, cls, tip) {
                h += '<span id="word' + (id++) + '" class="' + cls + '"' + (tip ? ' title="' + tip + '"' : '') + '>' + word + '</span> ';
            }
            var asm = [];
            var lines = source.match(/[^\r\n]+/g);
            if (lines) {
                for (var l in lines) {
                    var line = lines[l];
                    var words = line.match(/\S+/g);
                    if (words) {
                        for (var w = 0; w < words.length; w++) {
                            var word = words[w];
                            if (word == '\\') {
                                for (var j = w; j < words.length; j++) {
                                    addWord(words[j], 'comment');
                                }
                                break;
                            }
                            var i = parseInt(word);
                            if (!isNaN(i)) {
                                if (i < -128 || i > 127) {
                                    addWord(word, 'error');
                                    continue;
                                } else {
                                    addWord(word, 'literal');
                                    if (i < 0) {
                                        asm.push(~i);
                                        asm.push(0x8b); // `neg`
                                    } else {
                                        asm.push(i);
                                    }
                                }
                            } else {
                                var dic = dictionary[word];
                                if (dic) {
                                    if (dic.macro) dic.macro(asm);
                                    else asm.push(dic.op);
                                    addWord(word, 'word', dic.help);
                                } else {
                                    addWord(word, 'error');
                                    continue;
                                }
                            }
                        }
                    }
                    h = h.substr(0, h.length - 1) + '<br />';
                }
            }
            updateCodeHtml(h);
            return asm;
        }

        function encode(code) {
            code = [0x2D, 0x24, 0x93].concat(code);
            var enc = 'W';
            function append(i) {
                function color(i) {
                    switch (i) {
                        case 0: return 'K';
                        case 1: return 'R';
                        case 2: return 'G';
                        case 3: return 'Y';
                        case 4: return 'B';
                        case 5: return 'M';
                        case 6: return 'C';
                        default: throw 'Invalid color digit: ' + i;
                    }
                }
                var c = color(i);
                enc += enc[enc.length - 1] == c ? 'W' : c;
            }
            function checksum(bytes) {
                var chk = 0;
                for (var i in bytes) {
                    chk -= bytes[i];
                    chk >>>= 0; // unsigned
                    chk &= 0xff; // byte
                }
                return chk;
            }
            var ver = [1, 3];
            var len = code.length;
            var length = [219 - len, 0, len]; // TODO: why?
            var pre = ver.concat(length, code);
            var chk = checksum(pre);
            var framed = [304, 320, 302].concat(pre, chk, 334);
            for (var i in framed) {
                var v = framed[i];
                append(Math.floor(v / 49) % 7);
                append(Math.floor(v / 7) % 7);
                append(v % 7);
            }
            return enc;
        }

        function flashCodes(colors) {
            if (colors.length > 1) {
                colors = colors.substr(1, colors.length - 2); // trim off whites
                var h = "";
                for (var i in colors) {
                    var c = colors[i];
                    h += "<span class='" + c + "'>&nbsp;</span> ";
                }
                return h;
            }
        }

        function getSource() {
            return document.getElementById('source').innerHTML.replace(/<[^>]+>/g, ' ').replace('&nbsp;', ' ');
        }

        function update() {
            var source = getSource();
            var code = assemble(source);
            var colors = flashCodes(encode(code));
            document.getElementById('asm').innerHTML = code.map(function (x) { return x.toString(16) }).join(' ');
            document.getElementById('flash').innerHTML = colors;
        }

        var flashing = false;
        function blink(colors) {
            if (flashing && colors.length > 0) {
                document.getElementById('pad').className = colors[0];
                window.setTimeout(function() { blink(colors.substr(1)); }, 50);
            } else {
                document.getElementById("load").textContent = "Load";
                document.getElementById('pad').className = 'W';
                flashing = false;
            }
        }

        function flash() {
            if (flashing) {
                flashing = false; // cause abort
            } else {
                var colors = encode(assemble(getSource()));
                // prompt('Loading', colors);
                document.getElementById("load").textContent = "Stop";
                flashing = true;
                window.setTimeout(function () { blink(colors); }, 0);
            }
        }

        window.addEventListener('DOMContentLoaded', function () {
            update();
            document.getElementById('load').addEventListener('click', flash);
            var h = '';
            for (var w in dictionary) {
                var word = dictionary[w];
                if (!word.internal)
                    h += '<tr><td>' + w + '</td><td>' + word.sig + '</td><td>' + word.help + '</td></tr>';
            }
            document.getElementById('help').innerHTML = h;
        });

        function hideAll() {
            function hide(name) {
                document.getElementById('tab_' + name).className = 'tab';
                document.getElementById('panel_' + name).style.display = 'none';
            }
            hide('code');
            hide('load');
            hide('samples');
            hide('help');
        }

        function show(panel) {
            hideAll();
            document.getElementById('tab_' + panel).className = 'tab selected';
            document.getElementById('panel_' + panel).style.display = '';
        }

        function sample(source) {
            document.getElementById('source').innerHTML = source;
            update();
            show('code');
        }
        </script>
    </head>
    <body>
        <table cellspacing="0">
            <tr>
                <td colspan="9">
                    <h1><a href="http://github.com/ashleyf/ozobot">FlashForth for Ozobot</a></h1>
                </td>
            </tr>
            <tr id="tabs">
                <td class="spacer">&nbsp;</td>
                <td id="tab_code"class="tab selected" onclick="show('code')">Code</td>
                <td class="spacer">&nbsp;</td>
                <td id="tab_load" class="tab" onclick="show('load')">Load</td>
                <td class="spacer">&nbsp;</td>
                <td id="tab_samples" class="tab" onclick="show('samples')">Samples</td>
                <td class="spacer">&nbsp;</td>
                <td id="tab_help" class="tab" onclick="show('help')">Help</td>
                <td class="spacer" width="100%">&nbsp;</td>
            </tr>
            <tr id="panelrow">
                <td id="panels" colspan="9">
                    <div id="panel_code">
                        <div id="source" contenteditable="true" onkeyup="update()">
                            \ blink red, green, blue with 1 sec. pauses<br />
                            127 0 0 led<br />
                            100 wait<br />
                            0 127 0 led<br />
                            100 wait<br />
                            0 0 127 led<br />
                            100 wait<br />
                            OFF end
                        </div>
                        <p id="syntax" style="text-align: left; padding-left: 0.5em; font-size: small; font-family: monospace"></p>
                        <p id="asm"></p>
                        <p id="flash" style="font-size: 0px"></p>
                    </div>
                    <div id="panel_load" style="display: none">
                        <button id="load">Load</button><br />
                        <div class='W' id="pad"></div>
                    </div>
                    <div id="panel_samples" style="display: none">
                        <ul>
                            <li>
                                <a href="javascript:sample('127 0 0 led<br />100 wait<br />0 127 0 led<br />100 wait<br />0 0 127 led<br />100 wait<br />OFF end')">Blink red/green/blue</a><br />Blink LED red, then green, then blue with 1 second pauses.
                            </li>
                            <li>
                                <a href="javascript:sample('while TRUE do<br />  127 -127 wheels<br />127 wait<br />-127 127 wheels<br />127 wait<br />loop')">Spin in place</a><br />Spin in place by reversing differential drive wheel speeds.
                            </li>
                        </ul>
                    </div>
                    <div id="panel_help" style="display: none">
                        <h1>FlashForth Words</h1>
                        <table id="help" cellpadding="0" cellspacing="0"></table>
                    </div>
                </td>
            </tr>
        </table>
    </body>
</html>
<!-- TODO
* Support negative
-->